<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard CLM 2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { font-family: 'Segoe UI', sans-serif; box-sizing: border-box; }
        body { 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            margin: 0;
            min-height: 100vh;
        }
        .dashboard-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 8px;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid rgba(255,255,255,0.5);
        }
        .kpi-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        .kpi-value { font-size: 20px; font-weight: 700; line-height: 1; }
        .kpi-label { font-size: 10px; opacity: 0.9; margin-top: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
        .section-title {
            font-size: 12px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-left: 3px solid #667eea;
            padding-left: 8px;
        }
        .footer-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid #667eea;
            transition: transform 0.2s;
            object-fit: cover;
        }
        .footer-avatar:hover { transform: scale(1.1); }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 24px;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalSlide 0.3s ease;
        }
        @keyframes modalSlide {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }
        .close:hover { color: #000; }
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px 50px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            z-index: 2000;
            text-align: center;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg {
            color: #e74c3c;
            margin-top: 16px;
            padding: 12px;
            background: #fdf2f2;
            border-radius: 8px;
            font-size: 14px;
            max-width: 400px;
        }
        .main-grid {
            display: grid;
            grid-template-columns: 260px 1fr 300px;
            grid-template-rows: auto 1fr auto;
            gap: 10px;
            flex: 1;
        }
        .header-area { grid-column: 1 / -1; }
        .left-panel { grid-column: 1; display: flex; flex-direction: column; gap: 10px; }
        .center-panel { grid-column: 2; display: grid; grid-template-rows: 1fr 1fr; gap: 10px; }
        .right-panel { grid-column: 3; display: flex; flex-direction: column; gap: 10px; }
        .footer-area { grid-column: 1 / -1; }
        .panel-content { overflow-y: auto; padding: 12px; height: calc(100% - 30px); }
        .panel-content::-webkit-scrollbar { width: 4px; }
        .panel-content::-webkit-scrollbar-thumb { background: #ccc; border-radius: 2px; }
        
        @media (max-width: 1200px) {
            .main-grid { grid-template-columns: 220px 1fr 260px; }
        }
        
        @media (max-width: 768px) {
            body { overflow-y: auto; }
            .dashboard-container { height: auto; min-height: 100vh; }
            .main-grid {
                grid-template-columns: 1fr;
                grid-template-rows: auto;
            }
            .left-panel, .center-panel, .right-panel { grid-column: 1; }
            .center-panel { grid-template-rows: auto auto; }
            .kpi-value { font-size: 18px; }
            .kpi-label { font-size: 9px; }
            .section-title { font-size: 11px; }
            .footer-area { font-size: 11px; }
            .footer-avatar { width: 28px; height: 28px; }
            .glass-panel { margin-bottom: 10px; }
            .center-panel > div { min-height: 300px; }
            .header-area .flex { flex-direction: column; gap: 12px; }
            .header-area .flex > div:last-child { width: 100%; justify-content: space-between; }
            .kpi-card { min-width: 0; flex: 1; padding: 8px; }
        }
        
        .educacion-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 12px;
        }
        .educacion-item:last-child { border-bottom: none; }
        .badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-danger { background: #f8d7da; color: #721c24; }
        .refresh-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            font-size: 20px;
            transition: transform 0.2s;
            z-index: 100;
        }
        .refresh-btn:hover { transform: scale(1.1); }
        .refresh-btn.spinning { animation: spin 1s linear infinite; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <div>Cargando datos...</div>
        <div id="error-container"></div>
    </div>

    <button class="refresh-btn hidden" id="refreshBtn" onclick="loadData()" title="Actualizar datos">
        <i class="fas fa-sync-alt"></i>
    </button>

    <div class="dashboard-container hidden" id="dashboard">
        <!-- Header -->
        <div class="header-area glass-panel" style="padding: 12px 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-baby text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 style="font-size: 18px; font-weight: 700; color: #2c3e50; margin: 0; line-height: 1.2;">Centro de Lactancia Materna</h1>
                        <p style="font-size: 11px; color: #7f8c8d; margin: 0;">Dashboard 2025 | <span id="periodo-display">Período 2025</span></p>
                    </div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <div class="kpi-card" style="min-width: 100px;">
                        <div class="kpi-value" id="total-hc">-</div>
                        <div class="kpi-label">Historias Clínicas</div>
                    </div>
                    <div class="kpi-card" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); min-width: 100px;">
                        <div class="kpi-value" id="total-madres">-</div>
                        <div class="kpi-label">Madres Asistidas</div>
                    </div>
                    <div class="kpi-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); min-width: 100px;">
                        <div class="kpi-value" id="total-leche">-</div>
                        <div class="kpi-label">Litros Extraídos</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="main-grid">
            <!-- Left Panel -->
            <div class="left-panel">
                <div class="glass-panel" style="flex: 1; display: flex; flex-direction: column; min-height: 280px;">
                    <div class="section-title" style="margin: 12px 12px 0 12px;">Atención en Internación</div>
                    <div class="panel-content">
                        <div style="margin-bottom: 16px; height: 140px;">
                            <canvas id="chartAtencion"></canvas>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <div style="background: #fff5f5; padding: 8px; border-radius: 8px; text-align: center; border-left: 3px solid #e74c3c;">
                                <div style="font-size: 16px; font-weight: 700; color: #e74c3c;" id="reingresos">-</div>
                                <div style="font-size: 10px; color: #666;">Reingresos</div>
                            </div>
                            <div style="background: #fffbeb; padding: 8px; border-radius: 8px; text-align: center; border-left: 3px solid #f59e0b;">
                                <div style="font-size: 16px; font-weight: 700; color: #f59e0b;" id="requieren-asistencia">-</div>
                                <div style="font-size: 10px; color: #666;">Requieren Asist.</div>
                            </div>
                            <div style="background: #f0fdf4; padding: 8px; border-radius: 8px; text-align: center; border-left: 3px solid #10b981; grid-column: 1 / -1;">
                                <div style="font-size: 16px; font-weight: 700; color: #10b981;" id="buena-succion">-</div>
                                <div style="font-size: 10px; color: #666;">Buena Succión</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="glass-panel" style="flex: 0.5; display: flex; flex-direction: column; min-height: 200px;">
                    <div class="section-title" style="margin: 12px 12px 0 12px;">Complicaciones</div>
                    <div class="panel-content" id="complicaciones-container"></div>
                </div>
            </div>

            <!-- Center Panel -->
            <div class="center-panel">
                <div class="glass-panel" style="display: flex; flex-direction: column; min-height: 350px;">
                    <div class="section-title" style="margin: 12px 12px 0 12px;">Educación Recibida (% SI)</div>
                    <div class="panel-content" style="flex: 1;">
                        <canvas id="chartEducacion"></canvas>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="glass-panel" style="display: flex; flex-direction: column; min-height: 250px;">
                        <div class="section-title" style="margin: 12px 12px 0 12px;">Alimentación al Alta</div>
                        <div class="panel-content" style="flex: 1;">
                            <canvas id="chartAlimentacion"></canvas>
                        </div>
                    </div>
                    <div class="glass-panel" style="display: flex; flex-direction: column; min-height: 250px;">
                        <div class="section-title" style="margin: 12px 12px 0 12px;">Extracción LH por Sector</div>
                        <div class="panel-content" style="flex: 1;">
                            <canvas id="chartExtraccion"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="right-panel">
                <div class="glass-panel" style="flex: 1; display: flex; flex-direction: column; min-height: 400px;">
                    <div class="section-title" style="margin: 12px 12px 0 12px;">Detalle Educación (SI/NO)</div>
                    <div class="panel-content" style="flex: 1; font-size: 12px;">
                        <div id="educacion-list"></div>
                    </div>
                </div>
                
                <div class="glass-panel" style="flex: 0.3; padding: 12px; min-height: 150px;">
                    <div class="section-title" style="margin: 0 0 8px 0;">Métricas Extracción</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px; border-radius: 8px; text-align: center;">
                            <div class="kpi-value" id="total-binomios">-</div>
                            <div style="font-size: 10px; opacity: 0.9;">Binomios</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 12px; border-radius: 8px; text-align: center;">
                            <div class="kpi-value" id="minutos-maquina">-</div>
                            <div style="font-size: 10px; opacity: 0.9;">Minutos</div>
                        </div>
                    </div>
                    <div style="margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 6px; font-size: 10px; color: #666; text-align: center;" id="periodo-extraccion">
                        <i class="fas fa-calendar-alt" style="margin-right: 4px;"></i>Cargando...
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="footer-area glass-panel" style="padding: 12px 16px;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                    <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <img src="https://img.freepik.com/premium-vector/portrait-business-woman_505024-2799.jpg?semt=ais_hybrid&w=740&q=80" alt="Valeria Flores" class="footer-avatar" onclick="openModal('valeria')">
                            <div>
                                <div style="font-size: 10px; color: #7f8c8d; text-transform: uppercase; letter-spacing: 0.5px;">Director del Proyecto</div>
                                <div style="font-size: 13px; font-weight: 600; color: #2c3e50;">Mg. Valeria Flores</div>
                                <div style="font-size: 10px; color: #667eea;"><i class="fas fa-envelope" style="margin-right: 4px;"></i>valerianoemiflores.vnf@email.com</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <img src="https://static.vecteezy.com/system/resources/thumbnails/060/423/151/small/modern-avatar-icon-design-showing-a-faceless-man-in-formal-attire-perfect-for-professional-or-business-applications-free-png.png" alt="Alfredo Galván" class="footer-avatar" onclick="openModal('alfredo')">
                            <div>
                                <div style="font-size: 10px; color: #7f8c8d; text-transform: uppercase; letter-spacing: 0.5px;">Desarrollador</div>
                                <div style="font-size: 13px; font-weight: 600; color: #2c3e50;">Tec. Alfredo D. Galván</div>
                                <div style="font-size: 10px; color: #667eea;"><i class="fas fa-envelope" style="margin-right: 4px;"></i>alfredodgalvan@email.com</div>
                            </div>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 11px; color: #95a5a6;"><i class="fas fa-database" style="margin-right: 4px;"></i><span id="data-source">GitHub</span> | <span id="last-update">-</span></div>
                        <div style="font-size: 10px; color: #bdc3c7; margin-top: 4px;">Centro de Lactancia Materna © 2025</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modalValeria" class="modal" onclick="if(event.target === this) closeModal('valeria')">
        <div class="modal-content">
            <span class="close" onclick="closeModal('valeria')">&times;</span>
            <img src="https://img.freepik.com/premium-vector/portrait-business-woman_505024-2799.jpg?semt=ais_hybrid&w=740&q=80" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid #667eea; margin-bottom: 16px;">
            <h2 style="margin: 0; color: #2c3e50; font-size: 20px;">Mg. Valeria Flores</h2>
            <p style="color: #667eea; font-weight: 600; margin: 8px 0;">Directora del Proyecto</p>
            <p style="color: #7f8c8d; font-size: 14px; margin: 0;"><i class="fas fa-envelope" style="margin-right: 8px;"></i>valerianoemiflores.vnf@email.com</p>
        </div>
    </div>

    <div id="modalAlfredo" class="modal" onclick="if(event.target === this) closeModal('alfredo')">
        <div class="modal-content">
            <span class="close" onclick="closeModal('alfredo')">&times;</span>
            <img src="https://static.vecteezy.com/system/resources/thumbnails/060/423/151/small/modern-avatar-icon-design-showing-a-faceless-man-in-formal-attire-perfect-for-professional-or-business-applications-free-png.png" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid #667eea; margin-bottom: 16px;">
            <h2 style="margin: 0; color: #2c3e50; font-size: 20px;">Tec. Alfredo D. Galván</h2>
            <p style="color: #667eea; font-weight: 600; margin: 8px 0;">Desarrollador Web</p>
            <p style="color: #7f8c8d; font-size: 14px; margin: 0;"><i class="fas fa-envelope" style="margin-right: 8px;"></i>alfredodgalvan@email.com</p>
        </div>
    </div>

    <script>
        // URL de tu CSV en GitHub (usando proxy CORS)
        const CSV_URL = 'https://api.allorigins.win/raw?url=' + encodeURIComponent('https://raw.githubusercontent.com/AAGG22/CLM_2025/refs/heads/main/CLM_2025_dashboard_estructurado.csv');
        
        // Alternativa: Google Sheets publicado (cuando lo configures)
        // const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-.../pub?output=csv';
        
        let charts = {};

        async function loadData() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('refreshBtn').classList.add('spinning');
            document.getElementById('error-container').innerHTML = '';
            
            try {
                const response = await fetch(CSV_URL);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                console.log('CSV cargado:', csvText.substring(0, 200)); // Debug
                
                const data = parseCSV(csvText);
                console.log('Datos parseados:', data.length, 'filas'); // Debug
                
                if (data.length === 0) {
                    throw new Error('No se pudieron parsear los datos del CSV');
                }
                
                processData(data);
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard').classList.remove('hidden');
                document.getElementById('refreshBtn').classList.remove('hidden');
                document.getElementById('refreshBtn').classList.remove('spinning');
                document.getElementById('last-update').textContent = new Date().toLocaleString('es-ES');
                
            } catch (error) {
                console.error('Error completo:', error);
                document.getElementById('error-container').innerHTML = `
                    <div class="error-msg">
                        <strong>Error al cargar datos</strong><br>
                        ${error.message}<br><br>
                        <button onclick="loadData()" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">Reintentar</button>
                        <button onclick="useLocalData()" style="padding: 8px 16px; background: #27ae60; color: white; border: none; border-radius: 6px; cursor: pointer; margin-left: 8px;">Usar datos locales</button>
                    </div>
                `;
                document.getElementById('refreshBtn').classList.remove('spinning');
            }
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length < 2) return [];
            
            const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, '').replace(/\r$/, ''));
            const result = [];
            
            for (let i = 1; i < lines.length; i++) {
                const currentline = lines[i].split(',');
                // Si la línea está vacía, saltar
                if (currentline.length < 2) continue;
                
                const obj = {};
                for (let j = 0; j < headers.length; j++) {
                    let val = currentline[j] ? currentline[j].trim() : '';
                    val = val.replace(/^"|"$/g, '').replace(/\r$/, '');
                    obj[headers[j]] = val;
                }
                result.push(obj);
            }
            return result;
        }

        function processData(data) {
            const datos = {};
            data.forEach(row => {
                if (!row.Seccion) return;
                if (!datos[row.Seccion]) datos[row.Seccion] = [];
                datos[row.Seccion].push(row);
            });

            console.log('Secciones encontradas:', Object.keys(datos)); // Debug

            // Metadata
            if (datos.METADATA) {
                const metadata = {};
                datos.METADATA.forEach(item => { 
                    if (item.Indicador) metadata[item.Indicador] = item.Valor; 
                });
                document.getElementById('total-hc').textContent = parseInt(metadata.Total_Historias_Clinicas || 0).toLocaleString();
                document.getElementById('periodo-display').textContent = 'Período ' + (metadata.Periodo || '2025');
            }

            // Atención Madres
            if (datos.ATENCION_MADRES) {
                const atencion = {};
                datos.ATENCION_MADRES.forEach(item => { 
                    if (item.Indicador) atencion[item.Indicador] = parseInt(item.Valor) || 0; 
                });
                document.getElementById('total-madres').textContent = atencion.Total_Madres ? atencion.Total_Madres.toLocaleString() : '-';
                document.getElementById('reingresos').textContent = atencion.Reingresos || '-';
                document.getElementById('requieren-asistencia').textContent = atencion.Requieren_Asisencia || '-';
                document.getElementById('buena-succion').textContent = atencion.Buena_Succion ? atencion.Buena_Succion.toLocaleString() : '-';
                
                updateChart('chartAtencion', 'doughnut', {
                    labels: ['Parto', 'Cesárea'],
                    datasets: [{
                        data: [atencion.Parto || 0, atencion.Cesarea || 0],
                        backgroundColor: ['#4ECDC4', '#FF6B6B'],
                        borderWidth: 0,
                        cutout: '65%'
                    }]
                }, {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12, padding: 10, font: { size: 10 } } }
                    }
                });
            }

            // Educación
            if (datos.EDUCACION) {
                const educacionLabels = [], educacionValues = [], educacionColors = [], educacionDetalle = [];
                
                datos.EDUCACION.forEach(item => {
                    if (!item.Indicador || item.Indicador === 'Total_Madres_Base') return;
                    
                    const nombre = item.Indicador.replace(/_/g, ' ');
                    const si = parseInt(item.Valor) || 0;
                    const no = parseInt(item.Auxiliar_NO_o_Detalle) || 0;
                    const total = si + no;
                    const porcentaje = total > 0 ? ((si / total) * 100) : 0;
                    
                    // Acortar nombre para el gráfico
                    const nombreCorto = nombre.length > 15 ? nombre.substring(0, 12) + '...' : nombre;
                    educacionLabels.push(nombreCorto);
                    educacionValues.push(porcentaje.toFixed(1));
                    educacionColors.push(porcentaje > 90 ? '#2ecc71' : porcentaje > 50 ? '#f39c12' : '#e74c3c');
                    
                    educacionDetalle.push({
                        nombre: nombre,
                        si: si,
                        no: no,
                        total: total,
                        porcentaje: porcentaje.toFixed(0),
                        codigo: item.Color_o_Codigo || ''
                    });
                });

                const isMobile = window.innerWidth <= 768;
                
                updateChart('chartEducacion', 'bar', {
                    labels: educacionLabels,
                    datasets: [{
                        label: '% Recibió educación',
                        data: educacionValues,
                        backgroundColor: educacionColors,
                        borderRadius: 4,
                        barThickness: isMobile ? 6 : 10
                    }]
                }, {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    categoryPercentage: 0.6,
                    barPercentage: 0.7,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { min: 0, max: 100, ticks: { font: { size: isMobile ? 8 : 9 } }, grid: { color: '#f0f0f0' } },
                        y: { 
                            ticks: { font: { size: isMobile ? 9 : 10 } }, 
                            grid: { display: false } 
                        }
                    }
                });

                // Lista detalle
                const listContainer = document.getElementById('educacion-list');
                listContainer.innerHTML = '';
                educacionDetalle.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'educacion-item';
                    const badgeClass = item.porcentaje > 90 ? 'badge-success' : item.porcentaje > 50 ? 'badge-warning' : 'badge-danger';
                    div.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 6px; flex: 1; min-width: 0;">
                            <span style="font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${item.nombre}</span>
                            ${item.codigo ? `<span style="background: #e0e0e0; padding: 2px 6px; border-radius: 4px; font-size: 10px; color: #666; flex-shrink: 0;">${item.codigo}</span>` : ''}
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px; flex-shrink: 0;">
                            <span class="badge ${badgeClass}">${item.porcentaje}%</span>
                            <span style="color: #999; font-size: 11px;">${item.si}</span>
                        </div>
                    `;
                    listContainer.appendChild(div);
                });
            }

            // Alimentación al Alta
            if (datos.ALIMENTACION_ALTA) {
                const aliLabels = [], aliValues = [], aliColors = [];
                
                datos.ALIMENTACION_ALTA.forEach(item => {
                    if (!item.Indicador || item.Indicador === 'Total_Evaluados') return;
                    aliLabels.push(item.Indicador.replace(/_/g, ' '));
                    aliValues.push(parseInt(item.Valor) || 0);
                    aliColors.push(item.Color_o_Codigo || '#95A5A6');
                });

                const isMobile = window.innerWidth <= 768;

                updateChart('chartAlimentacion', 'bar', {
                    labels: aliLabels,
                    datasets: [{
                        data: aliValues,
                        backgroundColor: aliColors,
                        borderRadius: 6,
                        barThickness: isMobile ? 30 : 40
                    }]
                }, {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { font: { size: 9 } }, grid: { color: '#f0f0f0' } },
                        x: { ticks: { font: { size: 9 } }, grid: { display: false } }
                    }
                }, [{
                    afterDatasetsDraw: function(chart) {
                        const ctx = chart.ctx;
                        chart.data.datasets.forEach((dataset, i) => {
                            const meta = chart.getDatasetMeta(i);
                            meta.data.forEach((bar, index) => {
                                const data = dataset.data[index];
                                const total = dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((data / total) * 100).toFixed(1);
                                ctx.fillStyle = '#2c3e50';
                                ctx.font = 'bold 11px Segoe UI';
                                ctx.textAlign = 'center';
                                ctx.fillText(data, bar.x, bar.y - 20);
                                ctx.fillStyle = '#7f8c8d';
                                ctx.font = '10px Segoe UI';
                                ctx.fillText(percentage + '%', bar.x, bar.y - 8);
                            });
                        });
                    }
                }]);
            }

            // Extracción LH
            if (datos.EXTRACCION_LH) {
                const extLabels = [], extValues = [], extColors = [];
                let totalBinomios = 0, minutos = 0, litros = 0, periodo = '';
                
                datos.EXTRACCION_LH.forEach(item => {
                    if (!item.Indicador) return;
                    
                    if (item.Indicador === 'Total_Binomios') totalBinomios = parseInt(item.Valor) || 0;
                    else if (item.Indicador === 'Minutos_Maquina') minutos = parseInt(item.Valor) || 0;
                    else if (item.Indicador === 'Litros_Extraidos') litros = parseFloat(item.Valor) || 0;
                    else if (item.Indicador === 'Periodo') periodo = item.Valor;
                    else if (['NEO', 'RPM', 'SIC', 'CE', 'UTIGO', 'Vacias'].includes(item.Indicador)) {
                        extLabels.push(item.Indicador);
                        extValues.push(parseInt(item.Valor) || 0);
                        extColors.push(item.Color_o_Codigo || '#95A5A6');
                    }
                });

                document.getElementById('total-binomios').textContent = totalBinomios ? totalBinomios.toLocaleString() : '-';
                document.getElementById('minutos-maquina').textContent = minutos ? (minutos / 1000).toFixed(0) + 'K' : '-';
                document.getElementById('total-leche').textContent = litros ? litros.toFixed(2) : '-';
                document.getElementById('periodo-extraccion').innerHTML = `<i class="fas fa-calendar-alt" style="margin-right: 4px;"></i>${periodo || 'Período no especificado'}`;

                const isMobile = window.innerWidth <= 768;
                
                updateChart('chartExtraccion', 'bar', {
                    labels: extLabels,
                    datasets: [{
                        data: extValues,
                        backgroundColor: extColors,
                        borderRadius: 6,
                        barThickness: isMobile ? 25 : 35
                    }]
                }, {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { font: { size: 9 } }, grid: { color: '#f0f0f0' } },
                        x: { ticks: { font: { size: 9 } }, grid: { display: false } }
                    }
                }, [{
                    afterDatasetsDraw: function(chart) {
                        const ctx = chart.ctx;
                        chart.data.datasets.forEach((dataset, i) => {
                            const meta = chart.getDatasetMeta(i);
                            meta.data.forEach((bar, index) => {
                                const data = dataset.data[index];
                                const total = dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((data / total) * 100).toFixed(1);
                                ctx.fillStyle = '#2c3e50';
                                ctx.font = 'bold 10px Segoe UI';
                                ctx.textAlign = 'center';
                                ctx.fillText(data, bar.x, bar.y - 15);
                                if (percentage > 3) {
                                    ctx.fillStyle = '#7f8c8d';
                                    ctx.font = '9px Segoe UI';
                                    ctx.fillText(percentage + '%', bar.x, bar.y - 4);
                                }
                            });
                        });
                    }
                }]);
            }

            // Complicaciones
            if (datos.COMPLICACIONES) {
                const container = document.getElementById('complicaciones-container');
                container.innerHTML = '';
                const comps = [];
                
                datos.COMPLICACIONES.forEach(item => {
                    if (!item.Indicador) return;
                    comps.push({
                        nombre: item.Indicador.replace(/_/g, ' '),
                        valor: parseInt(item.Valor) || 0,
                        color: item.Color_o_Codigo || '#95A5A6'
                    });
                });
                
                const maxVal = Math.max(...comps.map(c => c.valor), 1);
                
                comps.forEach(comp => {
                    const porcentaje = maxVal > 0 ? ((comp.valor / maxVal) * 100).toFixed(1) : 0;
                    const div = document.createElement('div');
                    div.style.marginBottom = '12px';
                    div.innerHTML = `
                        <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px;">
                            <span>${comp.nombre}</span>
                            <span style="font-weight: 600; color: ${comp.color};">${comp.valor}</span>
                        </div>
                        <div style="background: #e0e0e0; border-radius: 10px; height: 20px; overflow: hidden;">
                            <div style="height: 100%; width: ${porcentaje}%; background: ${comp.color}; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 11px; font-weight: 600; transition: width 1s ease;">
                                ${comp.valor > 0 ? porcentaje + '%' : ''}
                            </div>
                        </div>
                    `;
                    container.appendChild(div);
                });
            }
        }

        function updateChart(canvasId, type, data, options, plugins = []) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            if (charts[canvasId]) charts[canvasId].destroy();
            charts[canvasId] = new Chart(ctx, { type: type, data: data, options: options, plugins: plugins });
        }

        function openModal(person) { 
            document.getElementById('modal' + person.charAt(0).toUpperCase() + person.slice(1)).style.display = 'block'; 
        }
        function closeModal(person) { 
            document.getElementById('modal' + person.charAt(0).toUpperCase() + person.slice(1)).style.display = 'none'; 
        }

        // Datos locales de respaldo (por si falla la carga)
        function useLocalData() {
            const localData = [
                {Seccion: 'METADATA', Indicador: 'Total_Historias_Clinicas', Valor: '1260'},
                {Seccion: 'METADATA', Indicador: 'Periodo', Valor: '2025'},
                {Seccion: 'ATENCION_MADRES', Indicador: 'Total_Madres', Valor: '1132'},
                {Seccion: 'ATENCION_MADRES', Indicador: 'Parto', Valor: '644'},
                {Seccion: 'ATENCION_MADRES', Indicador: 'Cesarea', Valor: '488'},
                {Seccion: 'ATENCION_MADRES', Indicador: 'Reingresos', Valor: '29'},
                {Seccion: 'ATENCION_MADRES', Indicador: 'Requieren_Asisencia', Valor: '265'},
                {Seccion: 'ATENCION_MADRES', Indicador: 'Buena_Succion', Valor: '642'},
                {Seccion: 'EDUCACION', Indicador: 'Beneficios_Lactancia', Valor: '1125', Auxiliar_NO_o_Detalle: '7', Color_o_Codigo: 'TL'},
                {Seccion: 'EDUCACION', Indicador: 'Transicion_Leche', Valor: '1128', Auxiliar_NO_o_Detalle: '4', Color_o_Codigo: 'FA'},
                {Seccion: 'EDUCACION', Indicador: 'Frecuencia_Alimentacion', Valor: '1131', Auxiliar_NO_o_Detalle: '1', Color_o_Codigo: 'RO'},
                {Seccion: 'EDUCACION', Indicador: 'Regla_Oro', Valor: '1128', Auxiliar_NO_o_Detalle: '4', Color_o_Codigo: 'TPP'},
                {Seccion: 'EDUCACION', Indicador: 'Tecnica_Prendida_Pecho', Valor: '1113', Auxiliar_NO_o_Detalle: '19', Color_o_Codigo: 'ALAS'},
                {Seccion: 'EDUCACION', Indicador: 'Pautas_ALAS', Valor: '327', Auxiliar_NO_o_Detalle: '805', Color_o_Codigo: 'BLH'},
                {Seccion: 'EDUCACION', Indicador: 'Extraccion_Conservacion', Valor: '763', Auxiliar_NO_o_Detalle: '369', Color_o_Codigo: 'SH'},
                {Seccion: 'EDUCACION', Indicador: 'Senales_Hambre', Valor: '1129', Auxiliar_NO_o_Detalle: '3', Color_o_Codigo: 'SS'},
                {Seccion: 'EDUCACION', Indicador: 'Signos_Saciedad', Valor: '1131', Auxiliar_NO_o_Detalle: '1', Color_o_Codigo: 'LDM'},
                {Seccion: 'EDUCACION', Indicador: 'Lavado_Manus', Valor: '1131', Auxiliar_NO_o_Detalle: '1', Color_o_Codigo: 'PBQL'},
                {Seccion: 'EDUCACION', Indicador: 'Prevencion_BQL', Valor: '1132', Auxiliar_NO_o_Detalle: '0', Color_o_Codigo: 'BQL'},
                {Seccion: 'EDUCACION', Indicador: 'PDF_WhatsApp', Valor: '1122', Auxiliar_NO_o_Detalle: '10', Color_o_Codigo: 'WAPP'},
                {Seccion: 'ALIMENTACION_ALTA', Indicador: 'Pecho_Exclusivo', Valor: '633', Color_o_Codigo: '#2ECC71'},
                {Seccion: 'ALIMENTACION_ALTA', Indicador: 'Lactancia_Mixta', Valor: '97', Color_o_Codigo: '#F39C12'},
                {Seccion: 'ALIMENTACION_ALTA', Indicador: 'Formula', Valor: '9', Color_o_Codigo: '#E74C3C'},
                {Seccion: 'ALIMENTACION_ALTA', Indicador: 'Vacias', Valor: '104', Color_o_Codigo: '#95A5A6'},
                {Seccion: 'EXTRACCION_LH', Indicador: 'Periodo', Valor: '07/07/2025 al 31/12/2025'},
                {Seccion: 'EXTRACCION_LH', Indicador: 'Total_Binomios', Valor: '1402'},
                {Seccion: 'EXTRACCION_LH', Indicador: 'Litros_Extraidos', Valor: '253.96'},
                {Seccion: 'EXTRACCION_LH', Indicador: 'Minutos_Maquina', Valor: '35050'},
                {Seccion: 'EXTRACCION_LH', Indicador: 'NEO', Valor: '1220', Color_o_Codigo: '#9B59B6'},
                {Seccion: 'EXTRACCION_LH', Indicador: 'RPM', Valor: '107', Color_o_Codigo: '#3498DB'},
                {Seccion: 'EXTRACCION_LH', Indicador: 'SIC', Valor: '56', Color_o_Codigo: '#1ABC9C'},
                {Seccion: 'EXTRACCION_LH', Indicador: 'CE', Valor: '9', Color_o_Codigo: '#E67E22'},
                {Seccion: 'EXTRACCION_LH', Indicador: 'UTIGO', Valor: '3', Color_o_Codigo: '#34495E'},
                {Seccion: 'COMPLICACIONES', Indicador: 'Congestion', Valor: '66', Color_o_Codigo: '#E74C3C'},
                {Seccion: 'COMPLICACIONES', Indicador: 'Mastitis', Valor: '0', Color_o_Codigo: '#27AE60'},
                {Seccion: 'COMPLICACIONES', Indicador: 'Pezon_Dolor_Fisura', Valor: '13', Color_o_Codigo: '#F39C12'}
            ];
            
            document.getElementById('data-source').textContent = 'Local (respaldo)';
            processData(localData);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('refreshBtn').classList.remove('hidden');
        }

        // Cargar al iniciar
        window.onload = loadData;
        
        // Auto-refresh cada 60 segundos
        setInterval(loadData, 60000);
    </script>
</body>
</html>